---
output:
  pdf_document:
    latex_engine: xelatex
    keep_tex: false
geometry:
- paperwidth=9in
- paperheight=12in
- margin=0.05in
header-includes:
  \usepackage{fontspec}
  \setmainfont{Calibri}
  \usepackage{booktabs}
  \usepackage{colortbl}
  \usepackage{subfig}
  \usepackage{floatrow}
  \usepackage{sectsty}
  \usepackage{titlesec}
  \graphicspath{{C:/Users/tdmed/OneDrive/_Github/boomers-analytics/www}}
---
```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
library(gridExtra)
library(gtsummary)
library(pak)
library(kableExtra)
library(knitr)
library(pandoc)
library(ggplot2)
opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.pos = '!h')
```

\begin{minipage}{0.2\textwidth}
\centering
\includegraphics[width=1.5cm, height=1.5cm]{`r params_boom$team_logo`}
\end{minipage}
\hfill 
\begin{minipage}{0.5\textwidth}
\begin{center}
\textbf{\fontsize{24}{24}\selectfont `r params_boom$batter_name` Postgame Report}
\end{center}
\end{minipage}
\hfill
\begin{minipage}{0.2\textwidth}
\centering
\includegraphics[width=2.5cm, height=1.5cm]{fllogo2}
\end{minipage}
\vspace{-6mm} 

\begin{center}
\textbf{\normalsize `r params_boom$game_date` vs. `r params_boom$opponent_team`}
\end{center}
\vspace{-6mm} 

\begin{center}
\textbf{\LARGE Game Stats}
\end{center}
\vspace{-6mm} 
```{r game line}
kable(game_line, format = "latex",  linesep = "") %>%
  kable_styling(latex_options = "HOLD_position", position = "center")%>%
  column_spec(1, bold = TRUE, border_left = TRUE) %>%
  row_spec(row = 0, color = "white", background = "#12294b") %>%
  column_spec(ncol(game_line), border_right = TRUE)
```

\vspace{-6mm} 
\begin{center}
\textbf{\LARGE Plate Appearances}
\end{center}
\vspace{-8mm} 
```{r pa}
kable(pa, format = "latex",  linesep = "") %>%
  kable_styling(latex_options = "HOLD_position", position = "center")%>%
  column_spec(1, bold = TRUE, border_left = TRUE) %>%
  row_spec(row = 0, color = "white", background = "#12294b") %>%
  column_spec(ncol(pa), border_right = TRUE)
```

\vspace{-6mm} 
\begin{center}
\textbf{\LARGE Pitches and Results}
\end{center}
\vspace{-3mm} 
```{r pitches,echo=FALSE, warning=FALSE,fig.height = 2,fig.width=8.3, position= 'center'}
pitches_plot
# pitch_type_plot
```
\vspace{0mm} 

```{r pitch_types,echo=FALSE, warning=FALSE,fig.height = 2,fig.width=8.3, position= 'center'}
# pitches_plot
pitch_type_plot
```
\vspace{-6mm} 

```{r batted_ball_plot ,echo=FALSE, warning=FALSE,fig.height = 3.5,fig.width=4.2, fig.align='center', position= 'center'}
batted_balls_plot

```
\vspace{-6mm} 

\newpage
\begin{minipage}{0.2\textwidth}
\centering
\includegraphics[width=1.5cm, height=1.5cm]{`r params_boom$team_logo`}
\end{minipage}
\hfill 
\begin{minipage}{0.5\textwidth}
\begin{center}
\textbf{\fontsize{24}{24}\selectfont `r params_boom$batter_name` PA Log}
\end{center}
\end{minipage}
\hfill
\begin{minipage}{0.2\textwidth}
\centering
\includegraphics[width=2.5cm, height=1.5cm]{fllogo2}
\end{minipage}
\vspace{-6mm} 


\begin{center}
\textbf{\normalsize `r params_boom$game_date` vs. `r params_boom$opponent_team`}
\end{center}
\vspace{-2mm} 
```{r batted_balls2, results='asis', echo=FALSE, warning=FALSE, fig.align='center', fig.width = 9, fig.height=4 , include = F}

# 
# 
# for (i in unique(hitter_data$PA)) {
#   pa_track <- hitter_data %>%
#     filter(PA==i) %>%
#     mutate(Count = glue::glue("{Balls}-{Strikes}"),
#            caption = glue::glue("Inning {Inning} - PA {PA} vs. {sub('^\\\\S+\\\\s+', '', Pitcher)} ({PitcherThrows})")) %>%
#     dplyr::select(`#`=PitchofPA, Inning, Pitcher, PitcherThrows, Pitch = TaggedPitchType,Count, Outs, PitchCall, PlayResult, Result, EV = ExitSpeed, LA = Angle, Dist = Distance, PlateLocSide, PlateLocHeight, hc_x, hc_y,caption) %>%
#     mutate(Result = str_replace_all(Result, c('Single'='1B', 'Double' = '2B', 'Triple' = '3B', 'HomeRun' ='HR', 'Error' = 'E', 'FieldersChoice' = 'FC','CatchersInterference' = 'CI', 'Sacrifice' = 'SAC')),
#            PlayResult = str_replace_all(PlayResult, c('Single'='1B', 'Double' = '2B', 'Triple' = '3B', 'HomeRun' ='HR', 'Error' = 'E', 'FieldersChoice' = 'FC','CatchersInterference' = 'CI', 'Sacrifice' = 'SAC')),
#     )
#   
#   pa_flex <- pa_track %>%
#     dplyr::select(-c( PlateLocSide, PlateLocHeight, hc_x, hc_y, Inning, Pitcher, PitcherThrows,caption, PlayResult, PitchCall)) %>%
#     mutate(across(c(EV, LA, Dist), ~ round(.,0)))
#   
#   caption <- tail(pa_track$caption,1)
#   
#   pa_flex_plot <- flextable(pa_flex, cwidth = 'auto') %>%
#     add_header_row(values = caption, colwidths = ncol(pa_flex)) %>%
#     # set_table_properties(., width = .5, layout = "autofit") %>%
#     autofit() %>%
#     align(align = 'justify', part = 'all') %>%
#     bg(bg = "#12294b", part = "header") %>%
#     color(color = "white", part = "header") %>%
#     bg(i = ~ Pitch == 'FB', j = c('Pitch', '#'), bg = "red") %>%
#     bg(i = ~ Pitch == 'SI', j = c('Pitch', '#'), bg = "orange") %>%
#     bg(i = ~ Pitch == 'CT', j = c('Pitch', '#'), bg = "#FFD700") %>%
#     bg(i = ~ Pitch == 'CB', j = c('Pitch', '#'), bg = "#228b22") %>%
#     bg(i = ~ Pitch == 'SL', j = c('Pitch', '#'), bg = "#33A8FF") %>%
#     bg(i = ~ Pitch == 'CH', j = c('Pitch', '#'), bg = "#E398F7") %>%
#     bg(i = ~ Pitch == 'SPL', j = c('Pitch', '#'), bg = "black") %>%
#     bg(i = ~ Pitch == 'KN', j = c('Pitch', '#'), bg = "black") %>%
#     bg(i = ~ Pitch == 'KN', j = c('Pitch', '#'), bg = "black") %>%
#     bg(i = ~ grepl('1B|Single',Result), j = ~ Result, bg = "#ff4a65") %>%
#     bg(i = ~ grepl('2B|Double',Result), j = ~ Result, bg = "#785EF0") %>%
#     bg(i = ~ grepl('3B|Triple',Result), j = ~ Result, bg = "#FFB000") %>%
#     bg(i = ~ grepl('HR|HomeRun',Result), j = ~ Result, bg = "forestgreen") %>%
#     bg(i = ~ grepl('E',Result), j = ~ Result, bg = "purple") %>%
#     bg(i = ~ grepl('FC',Result), j = ~ Result, bg = "lightgrey") %>%
#     bg(i = ~ grepl('SAC',Result), j = ~ Result, bg = "darkgrey") %>%
#     bg(i = ~ grepl('Out|K',Result), j = ~ Result, bg = "black") %>%
#     color(j = c('#','Pitch'), color = 'white', part = 'body') %>%
#     color(i = ~ grepl('1B|2B|3B|HR|E|Out|K|SAC|Single|Double|Triple|HomeRun',Result), j = c('Result'), color = 'white', part = 'body') %>%
#     fontsize(size = 8, part = "all") %>%
#     bold(bold = TRUE, part = "all")
#   
#   pa_zone_plot <-
#     pa_zone <- ggplot(pa_track, aes(x=-PlateLocSide,y=PlateLocHeight))+
#     geom_segment(data=tonybaseball::home_plate_c_pov,aes( x=x,y=y,xend=xend,yend=yend), size = 1)+
#     annotate('rect', xmin = -0.85, xmax = 0.85, ymin = 1.6, ymax = 3.5, fill = 'black', color = 'black', alpha = 0.0001, linewidth = 1)+
#     xlim(-2,2)+
#     ylim(0,4)+
#     coord_equal()+
#     geom_point(aes(fill = Pitch), pch = 21, size = 4)+
#     scale_fill_manual(values = c('FB' = 'red', 'CB' = 'darkgreen', 'SI' = '#a34700',  'SL'='#33A8FF',
#                                  'CT' = 'gold',  'CH'='violet', 'OT' = 'black', 'SPL' = 'black', 'KN' = 'black',
#                                  'Fastball' = 'red', 'Curveball' = 'darkgreen', 'Sinker' = '#a34700',  'Slider'='#33A8FF',
#                                  'Cutter' = 'gold',  'Changeup'='violet', 'Other' = 'black', 'Splitter' = 'black', 'Knuckleball' = 'black')) +
#     theme_void()+
#     geom_text(aes(label = `#`), color = 'white', fontface = 'bold', size = 3)+
#     theme(
#       strip.background = element_rect(fill = "#12294b", color = "#12294b"),
#       strip.text = element_text(color = "white", size = 10),
#       legend.position = 'none',
#       legend.direction = "horizontal"
#     )
#   
#   pa_bb_plot <-ggplot()+
#     geom_mlb_stadium(stadium_ids = 'cubs',
#                      stadium_transform_coords = TRUE,
#                      stadium_segments = c('home_plate', 'foul_lines', 'infield_outer', 'infield_inner') ,
#                      size = 1,
#                      color = 'black')+
#     
#     geom_segment(data = of_wall, aes(x = Start_x,y=Start_y, xend = End_x, yend = End_y), size = 1, color = 'black')+
#     geom_point(data = pa_track %>% filter(PitchCall == 'InPlay'), aes(x = hc_x, y = hc_y, fill = PlayResult), pch = 21, size = 5, color = 'black')+
#     scale_fill_manual(values = c('1B' = '#ff4a65', '2B' = '#785EF0', '3B' = '#FFB000',  'HR'='forestgreen', 'Out' = 'black',
#                                  'E' = 'purple',  'FC'='lightgrey', 'SAC' = 'darkgrey')) +
#     xlim(-275,275)+
#     ylim(-35,450)+
#     coord_equal()+
#     theme_void()+
#     theme(plot.title = element_text(hjust = .5, face = 'bold', color = 'black'),
#           plot.subtitle = element_text(hjust = .5, face = 'bold', color = 'black'),
#           legend.position = 'none')
#   
#   print(
#     
#     wrap_elements(full = gen_grob(pa_flex_plot, fit = "fixed", just = "centre", autowidths = T)) +
#       pa_zone_plot+ pa_bb_plot +
#       plot_layout(widths = c(.6, .3, .3))
#   )
#   cat("\\vspace{-25mm}")
# }
# 


```

```{r batted_balls2_png, echo=FALSE, warning=FALSE, fig.align='center', fig.width = 8.4, fig.height=11.4, include = F }
# cl
```

```{r pa_tracker, results='asis', echo=FALSE, warning=FALSE, fig.align='center', include = T, fig.height=2.5  }



for (i in unique(hitter_data$PA)) {
  pa_track <- hitter_data %>%
    filter(PA==i) %>%
    mutate(Count = glue::glue("{Balls}-{Strikes}"),
           caption = glue::glue("Inning {Inning} - PA {PA} vs. {sub('^\\\\S+\\\\s+', '', Pitcher)} ({PitcherThrows})")) %>%
    dplyr::select(`#`=PitchofPA, Inning, Pitcher, PitcherThrows, Pitch = TaggedPitchType, Velo = RelSpeed,Count, Outs, PitchCall, PlayResult, Result, EV = ExitSpeed, LA = Angle, Dist = Distance, VB = InducedVertBreak, HB = HorzBreak, Spin = SpinRate, Tilt, PlateLocSide, PlateLocHeight, hc_x, hc_y,caption) %>%
    mutate(Result = str_replace_all(Result, c('Single'='1B', 'Double' = '2B', 'Triple' = '3B', 'HomeRun' ='HR', 'Error' = 'E', 'FieldersChoice' = 'FC','CatchersInterference' = 'CI', 'Sacrifice' = 'SAC')),
           PlayResult = str_replace_all(PlayResult, c('Single'='1B', 'Double' = '2B', 'Triple' = '3B', 'HomeRun' ='HR', 'Error' = 'E', 'FieldersChoice' = 'FC','CatchersInterference' = 'CI', 'Sacrifice' = 'SAC')),
    )
  
  pa_flex <- pa_track %>%
    dplyr::select(-c( PlateLocSide, PlateLocHeight, hc_x, hc_y, Inning, Pitcher, PitcherThrows,caption, PlayResult, PitchCall)) %>%
    mutate(across(c(EV, LA, Dist, VB, HB, Velo), ~ round(.,1)))%>%
    mutate(across(c(Spin), ~ round(.)))
  
  caption <- tail(pa_track$caption,1)
  
  
  
  pa_zone_plot <-
    pa_zone <- ggplot(pa_track, aes(x=-PlateLocSide,y=PlateLocHeight))+
    geom_segment(data=tonybaseball::home_plate_c_pov,aes( x=x,y=y,xend=xend,yend=yend), size = 1)+
    annotate('rect', xmin = -.78, xmax = .78, ymin = 1.6, ymax = 3.5, fill = 'black', color = 'black', alpha = 0.0001, linewidth = 1)+
    xlim(-2.25,2.25)+
    ylim(0,4.5)+
    coord_equal()+
    geom_point(aes(fill = Pitch), pch = 21, size = 6)+
    scale_fill_manual(values = c('FB' = 'red', 'CB' = 'darkgreen', 'SI' = '#a34700',  'SL'='#33A8FF',
                                 'CT' = 'orange',  'CH'='violet', 'OT' = 'black', 'SPL' = 'black', 'KN' = 'black',
                                 'Fastball' = 'red', 'Curveball' = 'darkgreen', 'Sinker' = '#a34700',  'Slider'='#33A8FF',
                                 'Cutter' = 'orange',  'Changeup'='violet', 'Other' = 'black', 'Splitter' = 'black', 'Knuckleball' = 'black')) +
    theme_void()+
    geom_text(aes(label = `#`), color = 'white', fontface = 'bold', size = 4.5)+
    theme(
      strip.background = element_rect(fill = "#12294b", color = "#12294b"),
      strip.text = element_text(color = "white", size = 10),
      legend.position = 'none',
      legend.direction = "horizontal"
    )
  
  pa_bb_plot <-ggplot()+
    geom_mlb_stadium(stadium_ids = 'cubs',
                     stadium_transform_coords = TRUE,
                     stadium_segments = c('home_plate', 'foul_lines', 'infield_outer', 'infield_inner') ,
                     size = 1,
                     color = 'black')+
    
    geom_segment(data = of_wall, aes(x = Start_x,y=Start_y, xend = End_x, yend = End_y), size = 1, color = 'black')+
    geom_point(data = pa_track %>% filter(PitchCall == 'InPlay'), aes(x = hc_x, y = hc_y, fill = PlayResult), pch = 21, size = 5, color = 'black')+
    scale_fill_manual(values = c('1B' = '#ff4a65', '2B' = '#785EF0', '3B' = '#FFB000',  'HR'='forestgreen', 'Out' = 'black',
                                 'E' = 'purple',  'FC'='lightgrey', 'SAC' = 'darkgrey')) +
    xlim(-275,275)+
    ylim(-35,450)+
    coord_equal()+
    theme_void()+
    theme(plot.title = element_text(hjust = .5, face = 'bold', color = 'black'),
          plot.subtitle = element_text(hjust = .5, face = 'bold', color = 'black'),
          legend.position = 'none')
  
  
  print(
    kable(pa_flex%>% 
            mutate(across(c(EV, LA, Dist, VB,HB,Spin,Tilt,Velo), ~ ifelse(is.na(.), "", .)))%>%  
            mutate(Pitch = as.character(paste(Pitch))), format = "latex", linesep = "") %>%
      kable_styling(latex_options = "HOLD_position", position = "center", font_size = 11) %>%
      column_spec(1, bold = TRUE, border_left = TRUE) %>%
      row_spec(0, color = "white", background = "#12294b") %>%
      column_spec(ncol(pa_flex), border_right = TRUE) %>%
      add_header_above(setNames(ncol(pa_flex), caption), bold = TRUE, background = "#12294b", color = "white") %>%
      # add_header_above(c(" " = ncol(pa_flex)), bold = TRUE) %>%
      column_spec(2, bold = TRUE, color = "white",
                  background = case_when(
                    pa_flex$Pitch == 'FB' ~ 'red',
                    pa_flex$Pitch == 'SI' ~ '#a34700',
                    pa_flex$Pitch == 'CT' ~ 'orange',
                    pa_flex$Pitch == 'CB' ~ '#228b22',
                    pa_flex$Pitch == 'SL' ~ '#33A8FF',
                    pa_flex$Pitch == 'CH' ~ '#E398F7',
                    pa_flex$Pitch == 'KN' ~ 'black',
                    pa_flex$Pitch == 'SPL' ~ 'black',
                    TRUE ~ 'darkgrey'
                  )
      )%>%
      column_spec(1, bold = TRUE, color = "white",
                  background = case_when(
                    pa_flex$Pitch == 'FB' ~ 'red',
                    pa_flex$Pitch == 'SI' ~ '#a34700',
                    pa_flex$Pitch == 'CT' ~ 'orange',
                    pa_flex$Pitch == 'CB' ~ '#228b22',
                    pa_flex$Pitch == 'SL' ~ '#33A8FF',
                    pa_flex$Pitch == 'CH' ~ '#E398F7',
                    pa_flex$Pitch == 'KN' ~ 'black',
                    pa_flex$Pitch == 'SPL' ~ 'black',
                    TRUE ~ 'darkgrey'
                  )
      ) 
  )
  cat("\\vspace{-10mm}")
  grid.arrange(pa_zone_plot, pa_bb_plot, nrow = 1)
  cat("\\vspace{-10mm}")
  cat("--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------")
  # cat("___") 
}

```