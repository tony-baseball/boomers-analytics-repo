---
output:
  pdf_document: 
    latex_engine: xelatex
    keep_tex: false
geometry: 
  - paperwidth=8.5in
  - paperheight=11in
  - margin=0.05in 
 
header-includes:
  \usepackage{fontspec}
  \setmainfont{Calibri}
  \usepackage{booktabs}
  \usepackage{colortbl}
  \usepackage{subfig}
  \usepackage{floatrow}
  \usepackage{sectsty}
  \usepackage{titlesec}
  \graphicspath{{C:/Users/tdmed/OneDrive/_Github/boomers-analytics/www}}

---
```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
library(gridExtra)
library(gtsummary)
library(pak)
library(kableExtra)
library(knitr)
library(pandoc)
library(ggplot2)
opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.pos = '!h')
```

\begin{minipage}{0.3\textwidth}
\centering
\includegraphics[width=2cm, height=2cm]{Schaumburg}
\end{minipage}
\hfill 
\begin{minipage}{0.3\textwidth}
\begin{center}
\textbf{\fontsize{24}{24}\selectfont `r params$pitcher`}
\end{center}
\end{minipage}
\hfill
\begin{minipage}{0.3\textwidth}
\centering
\includegraphics[width=3cm, height=2cm]{fllogo2}
\end{minipage}


\vspace{-7mm} 
\begin{center}
\textbf{\normalsize `r params$date` vs `r params$opponent`}
\end{center}
\vspace{-7mm} 

\begin{center}
\textbf{\normalsize Game Line}
\end{center}
\vspace{-6mm} 
```{r game stats, echo=FALSE, warning=FALSE }


kable(game_stats, format = "latex",  linesep = "") %>%
  kable_styling(latex_options = "HOLD_position", position = "center")%>%
  column_spec(1, bold = TRUE, border_left = TRUE) %>%
  row_spec(row = 0, color = "white", background = "#12294b") %>%
  column_spec(ncol(game_stats), border_right = TRUE)
```
\vspace{-9mm} 
\begin{center}
\textbf{\normalsize Pitch Chracteristics}
\end{center}
\vspace{-6mm} 
```{r game summary,warning=FALSE,echo=FALSE}

game_summary_table  %>%
  kable(format = "latex",  linesep = "", label = "Game Summary") %>%
  kable_styling(latex_options = "HOLD_position", position = "center", font_size = 10) %>%
  column_spec(1, bold = TRUE, border_left = TRUE, color = "white", 
              background = case_when(
                game_summary_table$Pitch == 'FB' ~ 'red',
                game_summary_table$Pitch == 'SI' ~ '#a34700',
                game_summary_table$Pitch == 'CT' ~ 'orange',
                game_summary_table$Pitch == 'CB' ~ '#228b22',
                game_summary_table$Pitch == 'SL' ~ '#33A8FF',
                game_summary_table$Pitch == 'CH' ~ '#E398F7',
                TRUE ~ 'black'
              )
  ) %>% 
  kable_pitch_metrics_cond_frmt_hi_low() %>%
  kable_pitch_metrics_cond_frmt_hot_cold() %>%
  row_spec(row = 0, color = "white", background = "#12294b") %>%
  column_spec(ncol(game_summary_table), border_right = TRUE) 
```
\vspace{-9mm} 

\begin{center}
\centering
\textbf{\normalsize Pitch Stats}
\end{center}
\vspace{-6mm} 

```{r usage and batted ball, echo=FALSE, warning=FALSE, results='asis', include = F}
knitr::kables(
  list(
    knitr::kable(
      pitch_usage_table, valign = 't', label = 'Pitch Usage'
    ) %>%
      column_spec(1, bold = TRUE, border_left =  TRUE, color = "white",
                  background = ifelse(game_summary_table$Pitch == 'FB', 'red',
                                      ifelse(game_summary_table$Pitch == 'SI', '#a34700',
                                             ifelse(game_summary_table$Pitch == 'CT', 'orange',
                                                    ifelse(game_summary_table$Pitch == 'CB', '#228b22',
                                                           ifelse(game_summary_table$Pitch == 'SL', '#33A8FF',
                                                                  ifelse(game_summary_table$Pitch == 'CH', '#E398F7',
                                                                         
                                                                         
                                                                         'black'))))))
      )%>%
      row_spec(row = 0, color = "white", background = "#12294b")%>%
      column_spec(ncol(pitch_usage_table), border_right = TRUE),
    
    knitr::kable(batted_ball,  valign = 't', label = 'Batted Ball') %>%
      column_spec(1, bold = TRUE, border_left =  TRUE, color = "white",
                  background = ifelse(game_summary_table$Pitch == 'FB', 'red',
                                      ifelse(game_summary_table$Pitch == 'SI', '#a34700',
                                             ifelse(game_summary_table$Pitch == 'CT', 'orange',
                                                    ifelse(game_summary_table$Pitch == 'CB', '#228b22',
                                                           ifelse(game_summary_table$Pitch == 'SL', '#33A8FF',
                                                                  ifelse(game_summary_table$Pitch == 'CH', '#E398F7',
                                                                         
                                                                         
                                                                         'black'))))))
      )%>%
      row_spec(row = 0, color = "white", background = "#12294b") %>%
      column_spec(ncol(batted_ball), border_right = TRUE)
  ), format = "latex" )   %>%
  kable_styling(latex_options = "HOLD_position")

```


```{r pitch stats,warning=FALSE,echo=FALSE}
pitch_usage_table  %>%
  kable(format = "latex",  linesep = "", label = "pitch stats") %>%
  kable_styling(latex_options = "HOLD_position", position = "center", font_size = 10) %>%
  column_spec(1, bold = TRUE, border_left = TRUE, color = "white", 
              background = case_when(
                pitch_usage_table$Pitch == 'FB' ~ 'red',
                pitch_usage_table$Pitch == 'SI' ~ '#a34700',
                pitch_usage_table$Pitch == 'CT' ~ 'orange',
                pitch_usage_table$Pitch == 'CB' ~ '#228b22',
                pitch_usage_table$Pitch == 'SL' ~ '#33A8FF',
                pitch_usage_table$Pitch == 'CH' ~ '#E398F7',
                TRUE ~ 'black'
              )
  ) %>% 
  kable_pitch_stats_cond_frmt_hot_cold() %>%
  kable_pitch_stats_cond_frmt_hi_low() %>%
  
  row_spec(row = 0, color = "white", background = "#12294b") %>%
  column_spec(ncol(pitch_usage_table), border_right = TRUE) 

```
\vspace{-9mm} 

```{r, echo=FALSE, warning=FALSE, fig.width=7.8, fig.height = 3.4, fig.align='center'} 
# pitch_movement_plot
# arm_angle_plot
gridExtra::grid.arrange(pitch_movement_plot, arm_angle_plot, ncol = 2)
```
\vspace{-9mm} 

```{r, echo=FALSE, warning=FALSE, fig.width=7.8, fig.height = 2.9, fig.align='center'} 
gridExtra::grid.arrange(pvp_game_plot, pitch_dist_plot, ncol = 2)

# pvp_game_plot
# pitch_dist_plot
# rolling_stuff
```
\vspace{-1mm} 
\newpage
```{r, rhh usage and stats, echo=FALSE, warning=FALSE, include=FALSE}

if(nrow(usage_r)>0) {
  kable(usage_r, format = "latex")%>%
    kable_styling(latex_options = "HOLD_position",position = "left")%>%
    column_spec(1,  border_left = TRUE) %>%
    row_spec(row = 0, color = "white", background = "#12294b") %>%
    column_spec(ncol(usage_r), border_right = TRUE)
} else{"No data vs RHH available"}
if(nrow(usage_l)>0){
  kable(usage_l, format = "latex" )%>%
    kable_styling(latex_options = "HOLD_position",position = "left")%>%
    column_spec(1,  border_left = TRUE) %>%
    row_spec(row = 0, color = "white", background = "#12294b") %>%
    column_spec(ncol(usage_l), border_right = TRUE)
}else{"No data vs LHH available"}
```
\vspace{-2mm} 

\begin{center}
\begin{minipage}[t]{0.4\textwidth}
\centering
\textbf{\normalsize Pitch Usage vs Right}
\end{minipage}
\hfill
\begin{minipage}[t]{0.5\textwidth}
\centering
\textbf{\normalsize Pitch Usage vs Left}
\end{minipage}
\end{center}
\vspace{-5mm} 

```{r Vs R & L,echo=FALSE,warning=FALSE }


knitr::kables(
  list(
    if(nrow(usage_r) >0){
      knitr::kable(
        usage_r, valign = 't', label = 'Pitch Usage'
      ) %>%
        column_spec(1, bold = TRUE, border_left =  TRUE, color = "white",
                    background = ifelse(game_summary_table$Pitch == 'FB', 'red',
                                        ifelse(game_summary_table$Pitch == 'SI', '#a34700',
                                               ifelse(game_summary_table$Pitch == 'CT', 'orange',
                                                      ifelse(game_summary_table$Pitch == 'CB', '#228b22',
                                                             ifelse(game_summary_table$Pitch == 'CH', '#E398F7',
                                                                    ifelse(game_summary_table$Pitch == 'SL', '#33A8FF',
                                                                           'black'))))))
        )%>%
        row_spec(row = 0, color = "white", background = "#12294b")%>%
        column_spec(ncol(usage_r), border_right = TRUE)},
    
    if(nrow(usage_l) >0){
      knitr::kable(usage_l,  valign = 't', label = 'Batted Ball') %>%
        column_spec(1, bold = TRUE, border_left =  TRUE, color = "white",
                    background = ifelse(game_summary_table$Pitch == 'FB', 'red',
                                        ifelse(game_summary_table$Pitch == 'SI', '#a34700',
                                               ifelse(game_summary_table$Pitch == 'CT', 'orange',
                                                      ifelse(game_summary_table$Pitch == 'CB', '#228b22',
                                                             ifelse(game_summary_table$Pitch == 'CH', '#E398F7',
                                                                    ifelse(game_summary_table$Pitch == 'SL', '#33A8FF',
                                                                           'black'))))))
        )%>%
        row_spec(row = 0, color = "white", background = "#12294b") %>%
        column_spec(ncol(usage_l), border_right = TRUE) }
  ), 
  format = "latex" )    %>%
  kable_styling(latex_options = "HOLD_position")
```
\vspace{-9mm} 

\begin{center}
\begin{minipage}[t]{0.4\textwidth}
\centering
\textbf{\normalsize Game Line vs Right}
\end{minipage}
\hfill
\begin{minipage}[t]{0.5\textwidth}
\centering
\textbf{\normalsize Game Line vs Left}
\end{minipage}
\end{center}
\vspace{-6mm} 


```{r stats vs r and l, echo=FALSE, warning=FALSE}
knitr::kables(
  list(
    knitr::kable(
      stats_vs_r, valign = 't', label = 'Pitch Usage'
    ) %>%
      column_spec(1, bold = TRUE, border_left =  TRUE) %>%
      row_spec(row = 0, color = "white", background = "#12294b")%>%
      column_spec(ncol(stats_vs_r), border_right = TRUE),
    
    knitr::kable(
      stats_vs_l, valign = 't', label = 'Pitch Usage'
    ) %>%
      column_spec(1, bold = TRUE, border_left =  TRUE)%>%
      row_spec(row = 0, color = "white", background = "#12294b")%>%
      column_spec(ncol(stats_vs_l), border_right = TRUE)
  ), format = "latex" )    %>%
  kable_styling(latex_options = "HOLD_position")
```
\vspace{-6mm} 


```{r Pitch Location, echo=FALSE, warning=FALSE, fig.width=8.4,fig.height=3.25, position= 'center'} 
gridExtra::grid.arrange(plp_rhh, plp_lhh, ncol = 2)
```
\vspace{-10mm} 

\begin{center}
\textbf{\normalsize Situational Pitch Breakdown}
\end{center}
\vspace{-7mm} 
```{r breakdown, echo = F, warning = F, position='center', fig.height=3, fig.width=8, fig.align = 'center'}
breakdown
```
\vspace{-5mm} 
\begin{center}
\textbf{\normalsize Conditional Formatting Frontier League Percentile Guide}

Color coding compares to league average for each pitch type
\end{center}
\vspace{-7mm} 
```{r guide, echo = F, warning = F, position='center'}
colors_df_ex %>%
  slice(2) %>% 
  tibble::remove_rownames() %>%
  kable(format = "latex",  linesep = "", label = "pitch stats") %>%
  kable_styling(latex_options = "HOLD_position", position = "center", font_size = 10) %>%
  row_spec(row = 0, color = "white", background = "#12294b") %>%
  column_spec(ncol(colors_df_ex), border_right = TRUE) %>%
  row_spec(row = 1, background = c('white', hot_cold), color = c('black','white', 'black','black','black','black','white','white')) # %>%
  # row_spec(row = 2, background = c('white', higher_lower), color = c('black','white', 'black','black','black','black','white','white'))
```
\newpage












\begin{minipage}{0.2\textwidth}
\centering
\includegraphics[width=1.5cm, height=1.5cm]{`r params$team_logo`}
\end{minipage}
\hfill 
\begin{minipage}{0.5\textwidth}
\begin{center}
\textbf{\fontsize{24}{24}\selectfont `r params$pitcher_name` PA Log}
\end{center}
\end{minipage}
\hfill
\begin{minipage}{0.2\textwidth}
\centering
\includegraphics[width=2.5cm, height=1.5cm]{fllogo2}
\end{minipage}
\vspace{-6mm} 

\begin{center}
\textbf{\normalsize `r params$game_date` vs. `r params$opponent_team`}
\end{center}
\vspace{-6mm} 

```{r pa_tracker, results='asis', echo=FALSE, warning=FALSE, fig.align='center', include = T, fig.height=2.5  }



for (pa_i in unique(pitcher_data_PA$PA)) {
  pa_track <- pitcher_data_PA %>%
    filter(PA==pa_i) %>%
    mutate(#Count = glue::glue("{Balls}-{Strikes}"),
           caption = glue::glue("Inning {Inning} - PA {PA} vs. {sub('^\\\\S+\\\\s+', '', Batter)} ({BatterSide})")) %>%
    dplyr::select(`#`, Inning, Batter, BatterSide, Pitch,Velo, Count, Outs, PitchCall, PlayResult, Result, EV, LA, Dist = Distance, PlateLocSide, PlateLocHeight, hc_x, hc_y,caption, VB, HB, Spin, Tilt) %>%
    mutate(Result = str_replace_all(Result, c('Single'='1B', 'Double' = '2B', 'Triple' = '3B', 'HomeRun' ='HR', 'Error' = 'E', 'FieldersChoice' = 'FC','CatchersInterference' = 'CI', 'Sacrifice' = 'SAC')),
           PlayResult = str_replace_all(PlayResult, c('Single'='1B', 'Double' = '2B', 'Triple' = '3B', 'HomeRun' ='HR', 'Error' = 'E', 'FieldersChoice' = 'FC','CatchersInterference' = 'CI', 'Sacrifice' = 'SAC')),
    )
  
  pa_flex <- pa_track %>%
    dplyr::select(-c( PlateLocSide, PlateLocHeight, hc_x, hc_y, Inning, Batter, BatterSide,caption, PlayResult, PitchCall)) %>%
    mutate(across(c(VB,HB,EV, LA, Dist, Velo), ~ round(.,1))) %>%
    mutate(across(c(Spin), ~ round(.))) %>%
    relocate(VB,HB,Spin, Tilt, .after = Velo)
  
  caption <- tail(pa_track$caption,1)
  
  
  
  pa_zone_plot <-
    pa_zone <- ggplot(pa_track, aes(x=-PlateLocSide,y=PlateLocHeight))+
    geom_segment(data=tonybaseball::home_plate_c_pov,aes( x=x,y=y,xend=xend,yend=yend), size = 1)+
    annotate('rect', xmin = -0.78, xmax = 0.78, ymin = 1.6, ymax = 3.5, fill = 'black', color = 'black', alpha = 0.0001, linewidth = 1)+
    xlim(-2.25,2.25)+
    ylim(0,4.5)+
    coord_equal()+
    geom_point(aes(fill = Pitch), pch = 21, size = 6)+
    scale_fill_manual(values = c('FB' = 'red', 'CB' = 'darkgreen', 'SI' = '#a34700',  'SL'='#33A8FF',
                                 'CT' = 'orange',  'CH'='violet', 'OT' = 'black', 'SPL' = 'black', 'KN' = 'black',
                                 'Fastball' = 'red', 'Curveball' = 'darkgreen', 'Sinker' = '#a34700',  'Slider'='#33A8FF',
                                 'Cutter' = 'orange',  'Changeup'='violet', 'Other' = 'black', 'Splitter' = 'black', 'Knuckleball' = 'black')) +
    theme_void()+
    geom_text(aes(label = `#`), color = 'white', fontface = 'bold', size = 4.5)+
    theme(
      strip.background = element_rect(fill = "#12294b", color = "#12294b"),
      strip.text = element_text(color = "white", size = 10),
      legend.position = 'none',
      legend.direction = "horizontal"
    )
  
  htc <- unique(yakker_day$HomeTeamCode)
  
  of_wall <- dbGetQuery(db, glue::glue('select * from ballpark_dimensions where HomeTeamCode = "{htc}" '))
  
  pa_bb_plot <-ggplot()+
    geom_mlb_stadium(stadium_ids = 'cubs',
                     stadium_transform_coords = TRUE,
                     stadium_segments = c('home_plate', 'foul_lines', 'infield_outer', 'infield_inner') ,
                     size = 1,
                     color = 'black')+
    
    geom_segment(data = of_wall, aes(x = Start_x,y=Start_y, xend = End_x, yend = End_y), size = 1, color = 'black')+
    geom_point(data = pa_track %>% filter(PitchCall == 'InPlay'), aes(x = hc_x, y = hc_y, fill = PlayResult), pch = 21, size = 5, color = 'black')+
    scale_fill_manual(values = c('1B' = '#ff4a65', '2B' = '#785EF0', '3B' = '#FFB000',  'HR'='forestgreen', 'Out' = 'black',
                                 'E' = 'purple',  'FC'='lightgrey', 'SAC' = 'darkgrey')) +
    xlim(-275,275)+
    ylim(-35,450)+
    coord_equal()+
    theme_void()+
    theme(plot.title = element_text(hjust = .5, face = 'bold', color = 'black'),
          plot.subtitle = element_text(hjust = .5, face = 'bold', color = 'black'),
          legend.position = 'none')
  
  
  print(
    kable(pa_flex%>% 
            mutate(across(c(EV, LA, Dist, VB,HB,Spin,Tilt,Velo), ~ ifelse(is.na(.), "", .)))%>%  
            mutate(Pitch = as.character(paste(Pitch))), format = "latex", linesep = "") %>%
      kable_styling(latex_options = "HOLD_position", position = "center", font_size = 11) %>%
      column_spec(1, bold = TRUE, border_left = TRUE) %>%
      row_spec(0, color = "white", background = "#12294b") %>%
      column_spec(ncol(pa_flex), border_right = TRUE) %>%
      add_header_above(setNames(ncol(pa_flex), caption), bold = TRUE, background = "#12294b", color = "white") %>%
      # add_header_above(c(" " = ncol(pa_flex)), bold = TRUE) %>%
      column_spec(2, bold = TRUE, color = "white",
                  background = case_when(
                    pa_flex$Pitch == 'FB' ~ 'red',
                    pa_flex$Pitch == 'SI' ~ '#a34700',
                    pa_flex$Pitch == 'CT' ~ 'orange',
                    pa_flex$Pitch == 'CB' ~ '#228b22',
                    pa_flex$Pitch == 'SL' ~ '#33A8FF',
                    pa_flex$Pitch == 'CH' ~ '#E398F7',
                    pa_flex$Pitch == 'KN' ~ 'black',
                    pa_flex$Pitch == 'SPL' ~ 'black',
                    TRUE ~ 'darkgrey'
                  )
      ) %>%
      column_spec(1, bold = TRUE, color = "white",
                  background = case_when(
                    pa_flex$Pitch == 'FB' ~ 'red',
                    pa_flex$Pitch == 'SI' ~ '#a34700',
                    pa_flex$Pitch == 'CT' ~ 'orange',
                    pa_flex$Pitch == 'CB' ~ '#228b22',
                    pa_flex$Pitch == 'SL' ~ '#33A8FF',
                    pa_flex$Pitch == 'CH' ~ '#E398F7',
                    pa_flex$Pitch == 'KN' ~ 'black',
                    pa_flex$Pitch == 'SPL' ~ 'black',
                    TRUE ~ 'darkgrey'
                  )
      )
  )
  cat("\\vspace{-10mm}")
  grid.arrange(pa_zone_plot, pa_bb_plot, nrow = 1)
  cat("\\vspace{-10mm}")
  cat("------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------")
  # cat("___") 
}

```